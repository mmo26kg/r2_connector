version: '3.8'

services:
  # R2 Connector API
  r2-connector:
    build: .
    container_name: r2-connector-api
    ports:
      - "3000:3000"
    environment:
      # Cloudflare R2 Configuration
      - R2_ACCOUNT_ID=${R2_ACCOUNT_ID}
      - R2_ACCESS_KEY_ID=${R2_ACCESS_KEY_ID}
      - R2_SECRET_ACCESS_KEY=${R2_SECRET_ACCESS_KEY}
      - R2_BUCKET_NAME=${R2_BUCKET_NAME}
      
      # PostgreSQL Database (optional)
      - DATABASE_URL=${DATABASE_URL:-postgresql://postgres:postgres@postgres:5432/mydb}
      
      # Backup Cronjob (optional)
      - BACKUP_CRON_SCHEDULE=${BACKUP_CRON_SCHEDULE:-0 2 * * *}
      - BACKUP_TIMEZONE=${BACKUP_TIMEZONE:-Asia/Ho_Chi_Minh}
      
      # Server Port
      - PORT=3000
    volumes:
      # Mount volumes để giữ data khi container restart
      - ./backups:/app/backups
      - ./temp_uploads:/app/temp_uploads
    restart: unless-stopped
    networks:
      - r2-network
    depends_on:
      - postgres
    healthcheck:
      test: ["CMD", "node", "-e", "require('http').get('http://localhost:3000', (r) => {process.exit(r.statusCode === 200 ? 0 : 1)})"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 40s

  # PostgreSQL Database (optional - cho backup demo)
  postgres:
    image: postgres:17-alpine
    container_name: r2-postgres-demo
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=mydb
    ports:
      - "5432:5432"
    volumes:
      - postgres-data:/var/lib/postgresql/data
    restart: unless-stopped
    networks:
      - r2-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

volumes:
  postgres-data:
    driver: local

networks:
  r2-network:
    driver: bridge
